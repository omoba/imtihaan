<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>  Quiz - Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: clamp(1.8rem, 6vw, 2.5rem);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .screen {
            background: white;
            border-radius: 15px;
            padding: clamp(20px, 5vw, 40px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .ranking-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease-in;
        }

        .ranking-tile {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: clamp(30px, 8vw, 60px);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: bounceIn 1s ease-out;
            max-width: 90vw;
        }

        .ranking-number {
            font-size: clamp(4rem, 15vw, 8rem);
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .ranking-text {
            font-size: clamp(1.2rem, 4vw, 2rem);
            margin-bottom: 10px;
        }

        .ranking-score {
            font-size: clamp(1rem, 3vw, 1.5rem);
            opacity: 0.9;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: clamp(12px, 3vw, 15px) clamp(20px, 5vw, 30px);
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group input {
            padding: 15px;
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            border: 2px solid #e9ecef;
            border-radius: 10px;
            width: min(200px, 80vw);
            text-align: center;
        }

        .waiting-message {
            font-size: 1.2rem;
            color: #667eea;
            margin: 20px 0;
        }

        .question {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            margin: 20px 0;
            color: #2c3e50;
            line-height: 1.4;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: clamp(15px, 4vw, 20px);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #27ae60 !important;
            color: white !important;
            border-color: #27ae60 !important;
        }

        .option.incorrect {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        
        .option:disabled,
        .option[style*="pointer-events: none"] {
            cursor: default !important;
        }
        
        .option[style*="pointer-events: none"]:hover {
            background: inherit;
            border-color: inherit;
            transform: none;
        }

        .timer {
            font-size: clamp(1.5rem, 6vw, 2rem);
            font-weight: bold;
            color: #ff6b6b;
            margin: 20px 0;
        }

        .score {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            color: #27ae60;
            margin: 20px 0;
        }

        .story-content {
            text-align: left;
            max-height: 60vh;
            overflow-y: auto;
            margin: 20px 0;
        }

        .story-content h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: clamp(1.5rem, 4vw, 1.8rem);
        }

        .story-content p {
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: clamp(1rem, 2.2vw, 1.1rem);
        }

        .leaderboard {
            text-align: left;
            margin: 20px 0;
        }

        .leaderboard-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 5px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
            margin-right: 10px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .options {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 5px;
            }
            
            .header {
                margin-bottom: 15px;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .ranking-tile {
                margin: 20px;
            }
        }

        @media (max-width: 480px) {
            .screen {
                border-radius: 10px;
                padding: 15px;
            }
            
            .options {
                gap: 10px;
            }
            
            .option {
                min-height: 50px;
                padding: 12px;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .story-content {
                max-height: 40vh;
            }
            
            .ranking-tile {
                padding: 20px;
            }
            
            .ranking-number {
                font-size: clamp(3rem, 12vw, 5rem);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>  Quiz</h1>
            <p>Test your knowledge about avoiding doubtful matters</p>
        </div>

        <!-- Join Screen -->
        <div class="screen" id="joinScreen">
            <h2>Join Quiz</h2>
            <div class="input-group">
                <input type="text" id="playerName" placeholder="Enter Your Name" maxlength="20">
            </div>
            <button class="btn" onclick="joinRoom()">Join Quiz</button>
        </div>

        <!-- Waiting Screen -->
        <div class="screen hidden" id="waitingScreen">
            <h2>Waiting for Quiz to Start</h2>
            <div class="waiting-message">
                <p>You've joined the quiz successfully!</p>
                <p>Wait for the host to begin...</p>
            </div>
            <div class="score">Your Score: <span id="currentScore">0</span></div>
        </div>

        <!-- Story Screen -->
        <div class="screen hidden" id="storyScreen">
            <div class="story-content">
                <h2>Fun day at the Park</h2>
                <p>"As-salaamu alaykum, Hasan!" Amir called as he and his twin sister Amirah arrived at the park with their friends for Fun Day.</p>
                
                <p>"Wa alaykumu-s-salaam!" Hasan replied, racing toward the swings. The park was full of colorful equipment — slides, seesaws, swings, and monkey bars that the children always played on with permission.</p>
                
                <p>The parents sat under the shade, talking and watching the kids from a distance.</p>
                
                <p>Amirah pointed excitedly. "Let's go on the swings first!"</p>
                
                <p>Everyone agreed, and soon they were laughing and taking turns. After a while, one of the boys, Yusuf, pointed to the far side of the park. "Hey! What about that high climbing frame? Let's go!"</p>
                
                <p>Amir shook his head. "We're not allowed to use that unless an adult is with us. You know the rule."</p>
                
                <p>Yusuf shrugged. "Come on, no one will know."</p>
                
                <p>Amirah frowned gently. "But Allah will know. And we want Allah to be pleased with us, right?"</p>
                
                <p>Hasan nodded firmly. "Yes. Let's stay where we are allowed."</p>
                
                <p>The reminder was enough. They all walked away from the restricted area without arguing.</p>
                
                <p>A few minutes later, the group spotted something new — a tall climbing rope and wall, wrapped partly in plastic sheets. A small sign lay on the grass nearby, blown over by the wind.</p>
                
                <p>"Wow! I've never seen this here before," Hasan said.</p>
                
                <p>"Let's try it!" Yusuf said eagerly. "No one said we can't."</p>
                
                <p>"But we don't know if it's allowed," Amir reminded him. "And that hadith says that halal is clear, haram is clear, but doubtful things we should avoid."</p>
                
                <p>"Yeah," Amirah added, squinting at the equipment. "It even looks like it's still being built."</p>
                
                <p>Yusuf rolled his eyes. "There's no rule against it. I'm going up!"</p>
                
                <p>A few other kids followed him.</p>
                
                <p>Amir tried again. "Just because no one said we can't doesn't mean it's safe. Doubtful things are better avoided."</p>
                
                <p>But the others climbed anyway.</p>
                
                <p>Halfway up, one of the boys, Kareem, grabbed the rope firmly — and suddenly, without warning — the rope snapped.</p>
                
                <p>"AAAH!" he cried as he fell to the ground with a thud.</p>
                
                <p>Everyone gasped and ran to him. Kareem held his wrist tightly, tears filling his eyes. "It hurts… it hurts a lot…"</p>
                
                <p>Parents rushed over, and soon Kareem was taken to the hospital. Later, the children learned he had broken his hand.</p>
                
                <p>The following day at school, their teacher, Mr. Idris, gathered everyone.</p>
                
                <p>"I heard what happened at the park," he said gently. "Alhamdulillah, Kareem will recover. But that climbing rope was not ready for use. It was still under construction and had not been approved. You were warned to stay away from unfinished equipment."</p>
                
                <p>The children lowered their heads.</p>
                
                <p>Mr. Idris continued, "Our Prophet Muhammad ﷺ said: 'What is lawful is clear, and what is unlawful is clear, and between them are doubtful matters that many people do not know.' If something is doubtful — especially when it concerns your safety — the wise choice is to avoid it."</p>
                
                <p>Amir, Amirah, and Hasan exchanged quiet glances. They had remembered. And now everyone else understood why avoiding doubtful things protects not just our deen — but our bodies too.</p>
                
                <p>A valuable lesson had been learned.</p>
            </div>
            <div class="waiting-message">
                <p>Wait for the host to start the quiz...</p>
            </div>
            <button class="btn" onclick="markDoneReading()">Done Reading</button>
        </div>

        <!-- Quiz Screen -->
        <div class="screen hidden" id="quizScreen">
            <div class="timer" id="timer">30</div>
            <div class="question" id="question"></div>
            <div class="options" id="options"></div>
            <div class="score">Score: <span id="playerScore">0</span></div>
            <div class="waiting-message" id="waitingForNext" style="display: none;">
                <p>Waiting for host to continue...</p>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="screen hidden" id="resultsScreen">
            <h2>Quiz Complete!</h2>
            <div class="score">Your Final Score: <span id="finalScore">0</span></div>
            <div class="leaderboard" id="leaderboard"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="config.js"></script>
    <script>

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentRoom = null;
        let playerId = null;
        let playerName = '';
        let playerScore = 0;
        let currentQuestion = -1;
        let timeLeft = 30;
        let timerInterval = null;
        let selectedAnswer = null;
        let answerLocked = false;
        let hasAnswered = false;

        const questions = [
            {
                question: "What greeting did Amir call out when he arrived at the park?",
                options: ["Hello Hasan!", "As-salaamu alaykum, Hasan!", "Good morning Hasan!", "Hey there Hasan!"],
                correct: 1
            },
            {
                question: "What equipment did the children play on with permission?",
                options: ["Only swings", "Slides, seesaws, swings, and monkey bars", "Just the climbing frame", "Only the sandbox"],
                correct: 1
            },
            {
                question: "Why didn't Amir want to use the high climbing frame?",
                options: ["He was scared of heights", "It was broken", "They weren't allowed unless an adult was with them", "It was too crowded"],
                correct: 2
            },
            {
                question: "What did Amirah say when Yusuf suggested no one would know?",
                options: ["'That's a good idea'", "'But Allah will know'", "'Let's ask our parents first'", "'I'm too scared'"],
                correct: 1
            },
            {
                question: "What new equipment did the group discover?",
                options: ["A new swing set", "A tall climbing rope and wall", "A basketball court", "A water fountain"],
                correct: 1
            },
            {
                question: "What hadith did Amir mention about doubtful things?",
                options: ["'Always ask permission first'", "'Safety comes first'", "'Halal is clear, haram is clear, but doubtful things we should avoid'", "'Listen to your parents'"],
                correct: 2
            },
            {
                question: "What happened to Kareem when he climbed the rope?",
                options: ["He reached the top successfully", "The rope snapped and he fell", "He got stuck halfway", "He changed his mind and came down"],
                correct: 1
            },
            {
                question: "What injury did Kareem sustain from the fall?",
                options: ["A broken leg", "A sprained ankle", "A broken hand", "A bruised knee"],
                correct: 2
            },
            {
                question: "Who explained the lesson to the children the next day?",
                options: ["Their parents", "Mr. Idris, their teacher", "The park manager", "A doctor"],
                correct: 1
            },
            {
                question: "What was the main lesson learned from this story?",
                options: ["Never go to parks", "Always climb carefully", "Avoiding doubtful things protects both our deen and our bodies", "Only play with adult supervision"],
                correct: 2
            }
        ];

        // Get room code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
        }

        window.joinRoom = async () => {
            const playerNameInput = document.getElementById('playerName').value;
            const validatedName = validateInput(playerNameInput, 20);
            
            if (!validatedName) {
                alert('Please enter a valid name (1-20 characters)');
                return;
            }

            if (!roomFromUrl) {
                alert('Invalid room link');
                return;
            }

            playerName = validatedName;
            playerId = 'player_' + Date.now();
            currentRoom = roomFromUrl;

            try {
                const roomRef = database.ref(`rooms/${roomFromUrl}`);
                const snapshot = await roomRef.once('value');

                if (!snapshot.exists()) {
                    alert('Quiz room not found');
                    return;
                }

                await database.ref(`rooms/${roomFromUrl}/players/${playerId}`).set({
                    name: playerName,
                    score: 0
                });

                showWaitingScreen();
                listenToRoom();
            } catch (error) {
                alert('Error joining quiz. Please try again.');
            }
        };

        function showWaitingScreen() {
            hideAllScreens();
            document.getElementById('waitingScreen').classList.remove('hidden');
        }

        function listenToRoom() {
            const roomRef = database.ref(`rooms/${currentRoom}`);
            roomRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('Quiz has ended');
                    return;
                }

                const roomData = snapshot.val();
                
                if (roomData.gameState === 'story') {
                    showStoryScreen();
                } else if (roomData.gameState === 'quiz') {
                    showQuizScreen(roomData);
                } else if (roomData.gameState === 'results') {
                    showResultsScreen(roomData.players || {});
                }
            });
        }

        function showStoryScreen() {
            hideAllScreens();
            document.getElementById('storyScreen').classList.remove('hidden');
        }

        window.markDoneReading = async () => {
            try {
                await database.ref(`rooms/${currentRoom}/players/${playerId}/doneReading`).set(true);
                document.querySelector('#storyScreen .btn').textContent = 'Reading Complete ✓';
                document.querySelector('#storyScreen .btn').disabled = true;
            } catch (error) {
                console.error('Error marking done reading:', error);
            }
        };

        function showQuizScreen(roomData) {
            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hidden');
            
            const newQuestion = roomData.currentQuestion || 0;
            if (newQuestion !== currentQuestion) {
                currentQuestion = newQuestion;
                loadQuestion(roomData.questionStartTime);
            }
        }

        function loadQuestion(startTime) {
            if (currentQuestion >= questions.length) return;
            
            const q = questions[currentQuestion];
            document.getElementById('question').textContent = q.question;
            document.getElementById('playerScore').textContent = playerScore;
            
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            q.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.addEventListener('click', () => {
                    if (hasAnswered) return;
                    hasAnswered = true;
                    selectAnswer(index, optionDiv);
                });
                optionsContainer.appendChild(optionDiv);
            });
            
            selectedAnswer = null;
            answerLocked = false;
            hasAnswered = false;
            document.getElementById('waitingForNext').style.display = 'none';
            startTimer(startTime);
        }

        function startTimer(startTime) {
            clearInterval(timerInterval);
            
            // Always give players 30 seconds from when they load the question
            const playerStartTime = Date.now();
            
            const updateTimer = () => {
                const elapsed = Math.floor((Date.now() - playerStartTime) / 1000);
                timeLeft = Math.max(0, 30 - elapsed);
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timer').textContent = "Time's Up!";
                }
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        window.selectAnswer = async (index, element) => {
            console.log('selectAnswer called:', index);
            
            // Immediately disable all options
            const options = document.querySelectorAll('.option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.style.cursor = 'default';
            });
            
            console.log('Processing answer...');
            
            selectedAnswer = index;
            const q = questions[currentQuestion];
            
            // Always show the correct answer in green
            options[q.correct].classList.add('correct');
            
            // If wrong answer was selected, show it in red
            if (index !== q.correct) {
                element.classList.add('incorrect');
            } else {
                // If correct answer was selected, ensure it shows green
                element.classList.add('correct');
            }
            
            // Calculate score only once
            let points = 0;
            if (index === q.correct) {
                points = timeLeft > 0 ? timeLeft * 10 : 5;
                playerScore += points;
                console.log('Correct answer! Points added:', points, 'Total score:', playerScore);
            } else {
                console.log('Wrong answer, no points added');
            }
            
            document.getElementById('playerScore').textContent = playerScore;
            document.getElementById('currentScore').textContent = playerScore;
            
            // Update player score in database
            await database.ref(`rooms/${currentRoom}/players/${playerId}/score`).set(playerScore);
            
            clearInterval(timerInterval);
            
            // Show waiting message
            document.getElementById('waitingForNext').style.display = 'block';
        };

        function showResultsScreen(players) {
            const sortedPlayers = Object.entries(players).sort(([,a], [,b]) => (b.score || 0) - (a.score || 0));
            const playerRank = sortedPlayers.findIndex(([id]) => id === playerId) + 1;
            
            // Show animated ranking first
            showAnimatedRanking(playerRank, playerScore, sortedPlayers.length);
            
            // Prepare results screen data
            const prepareResults = () => {
                hideAllScreens();
                document.getElementById('resultsScreen').classList.remove('hidden');
                
                document.getElementById('finalScore').textContent = playerScore;
                
                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = '';
                
                sortedPlayers.forEach(([id, player], index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    if (id === playerId) {
                        item.style.background = '#e8f5e8';
                        item.style.fontWeight = 'bold';
                    }
                    const rankSpan = document.createElement('span');
                    rankSpan.className = 'rank';
                    rankSpan.textContent = `#${index + 1}`;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = player.name;
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.appendChild(rankSpan);
                    leftDiv.appendChild(nameSpan);
                    
                    const scoreSpan = document.createElement('span');
                    scoreSpan.textContent = `${player.score || 0} points`;
                    
                    item.appendChild(leftDiv);
                    item.appendChild(scoreSpan);
                    leaderboard.appendChild(item);
                });
            };
            
            // Store function globally for ranking overlay to call
            window.showFinalResults = prepareResults;
        }
        
        function showAnimatedRanking(rank, score, totalPlayers) {
            const rankingOverlay = document.createElement('div');
            rankingOverlay.className = 'ranking-animation';
            
            const getRankSuffix = (rank) => {
                if (rank === 1) return 'st';
                if (rank === 2) return 'nd';
                if (rank === 3) return 'rd';
                return 'th';
            };
            
            const getRankColor = (rank) => {
                if (rank === 1) return 'linear-gradient(135deg, #FFD700, #FFA500)';
                if (rank === 2) return 'linear-gradient(135deg, #C0C0C0, #A9A9A9)';
                if (rank === 3) return 'linear-gradient(135deg, #CD7F32, #B8860B)';
                return 'linear-gradient(135deg, #667eea, #764ba2)';
            };
            
            rankingOverlay.innerHTML = `
                <div class="ranking-tile" style="background: ${getRankColor(rank)}">
                    <div class="ranking-number">${rank}<sup>${getRankSuffix(rank)}</sup></div>
                    <div class="ranking-text">Place</div>
                    <div class="ranking-score">${score} points</div>
                    <div class="ranking-score">out of ${totalPlayers} players</div>
                </div>
            `;
            
            document.body.appendChild(rankingOverlay);
            
            // Add click to dismiss and show results
            rankingOverlay.onclick = () => {
                rankingOverlay.remove();
                if (window.showFinalResults) {
                    window.showFinalResults();
                }
            };
            
            // Add tap instruction
            const tapInstruction = document.createElement('div');
            tapInstruction.style.cssText = 'position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.8); font-size: 0.9rem;';
            tapInstruction.textContent = 'Tap to continue';
            rankingOverlay.querySelector('.ranking-tile').appendChild(tapInstruction);
        }

        // Auto-join if room code is in URL
        if (roomFromUrl) {
            document.getElementById('joinScreen').querySelector('h2').textContent = `Join Quiz Room: ${roomFromUrl}`;
        } else {
            document.getElementById('joinScreen').innerHTML = '<h2>Invalid Quiz Link</h2><p>Please use the correct link provided by your host.</p>';
        }
    </script>
</body>
</html>
