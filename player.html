<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>  Quiz - Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: clamp(1.8rem, 6vw, 2.5rem);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .screen {
            background: white;
            border-radius: 15px;
            padding: clamp(20px, 5vw, 40px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }

        .ranking-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.5s ease-in;
        }

        .ranking-tile {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: clamp(30px, 8vw, 60px);
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: bounceIn 1s ease-out;
            max-width: 90vw;
        }

        .ranking-number {
            font-size: clamp(4rem, 15vw, 8rem);
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
        }

        .ranking-text {
            font-size: clamp(1.2rem, 4vw, 2rem);
            margin-bottom: 10px;
        }

        .ranking-score {
            font-size: clamp(1rem, 3vw, 1.5rem);
            opacity: 0.9;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes bounceIn {
            0% { transform: scale(0.3) rotate(-10deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: clamp(12px, 3vw, 15px) clamp(20px, 5vw, 30px);
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .input-group {
            margin: 20px 0;
        }

        .input-group input {
            padding: 15px;
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            border: 2px solid #e9ecef;
            border-radius: 10px;
            width: min(200px, 80vw);
            text-align: center;
        }

        .waiting-message {
            font-size: 1.2rem;
            color: #667eea;
            margin: 20px 0;
        }

        .question {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            margin: 20px 0;
            color: #2c3e50;
            line-height: 1.4;
        }

        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            padding: clamp(15px, 4vw, 20px);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: clamp(1rem, 2.5vw, 1.1rem);
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .option:hover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .option.correct {
            background: #27ae60 !important;
            color: white !important;
            border-color: #27ae60 !important;
        }

        .option.incorrect {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }
        
        .option:disabled,
        .option[style*="pointer-events: none"] {
            cursor: default !important;
        }
        
        .option[style*="pointer-events: none"]:hover {
            background: inherit;
            border-color: inherit;
            transform: none;
        }

        .timer {
            font-size: clamp(1.5rem, 6vw, 2rem);
            font-weight: bold;
            color: #ff6b6b;
            margin: 20px 0;
        }

        .score {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            color: #27ae60;
            margin: 20px 0;
        }

        .story-content {
            text-align: left;
            max-height: 60vh;
            overflow-y: auto;
            margin: 20px 0;
        }

        .story-content h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: clamp(1.5rem, 4vw, 1.8rem);
        }

        .story-content p {
            line-height: 1.8;
            margin-bottom: 15px;
            font-size: clamp(1rem, 2.2vw, 1.1rem);
        }

        .leaderboard {
            text-align: left;
            margin: 20px 0;
        }

        .leaderboard-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 5px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
            margin-right: 10px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .options {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 5px;
            }
            
            .header {
                margin-bottom: 15px;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .ranking-tile {
                margin: 20px;
            }
        }

        @media (max-width: 480px) {
            .screen {
                border-radius: 10px;
                padding: 15px;
            }
            
            .options {
                gap: 10px;
            }
            
            .option {
                min-height: 50px;
                padding: 12px;
            }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .story-content {
                max-height: 40vh;
            }
            
            .ranking-tile {
                padding: 20px;
            }
            
            .ranking-number {
                font-size: clamp(3rem, 12vw, 5rem);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>  Quiz</h1>
            <p>Test your knowledge about excellence and kindness</p>
        </div>

        <!-- Join Screen -->
        <div class="screen" id="joinScreen">
            <h2>Join Quiz</h2>
            <div class="input-group">
                <input type="text" id="playerName" placeholder="Enter Your Name" maxlength="20">
            </div>
            <button class="btn" onclick="joinRoom()">Join Quiz</button>
        </div>

        <!-- Waiting Screen -->
        <div class="screen hidden" id="waitingScreen">
            <h2>Waiting for Quiz to Start</h2>
            <div class="waiting-message">
                <p>You've joined the quiz successfully!</p>
                <p>Wait for the host to begin...</p>
            </div>
            <div class="score">Your Score: <span id="currentScore">0</span></div>
        </div>

        <!-- Story Screen -->
        <div class="screen hidden" id="storyScreen">
            <div class="story-content">
                <h2>Modesty</h2>
                <p>It was a bright, sunny afternoon at school. Amirah and her best friend Hasanah were playing together in the playground after lunch. They laughed softly as they pushed each other on the swings. A group of older girls passed by, giggling loudly. One of them looked at Amirah and said mockingly, "Why are you always so shy? You never talk much or show off your new things. You should stop being so modest—it's boring!"</p>
                
                <p>Hasanah frowned. "That's not nice," she said. But the girls only laughed and walked away.</p>
                
                <p>Amirah's smile faded. She looked down and whispered, "Maybe they're right. Maybe I'm too quiet. Maybe being modest makes me strange."</p>
                
                <p>Just then, their teacher, Mrs. Rahma, walked by. "As-salāmu ʿalaykum, my dear girls," she greeted kindly. "Why do you look upset, Amirah?"</p>
                
                <p>"Wa ʿalaykum as-salām," they replied. Hasanah explained what had happened.</p>
                
                <p>Mrs. Rahma smiled gently. "Amirah, do you know what our beloved Prophet ﷺ said about modesty?"</p>
                
                <p>Amirah shook her head.</p>
                
                <p>The teacher said, "Once, the Prophet ﷺ passed by a man who was advising his brother not to be modest. The Prophet ﷺ said, 'Leave him alone, for modesty is a part of faith.'"</p>
                
                <p>Amirah blinked in surprise. "So… modesty is a good thing?"</p>
                
                <p>"Yes, my dear," said Mrs. Rahma. "Being modest doesn't mean you're weak. It means you respect yourself and others. A modest person tries to be good at all times and avoids what displeases Allah. Because when someone is modest, they think before they act—they don't lie, they don't show off, and they don't hurt others. They want Allah to be pleased with them."</p>
                
                <p>She continued softly, "But when a person loses modesty, they start doing whatever they want without caring about others or about Allah's rules. They become careless with their prayers, their manners, and their words. And when that happens, they may disobey Allah to get what they want—and that leads to Allah's anger and failure in this life and the Hereafter."</p>
                
                <p>Amirah listened carefully, her eyes wide with understanding. "Subḥānallāh," she whispered. "So modesty helps us stay close to Allah?"</p>
                
                <p>"That's right," said Mrs. Rahma with a warm smile. "It protects your heart and keeps your faith strong."</p>
                
                <p>Amirah felt a wave of peace in her heart. "Alḥamdulillāh," she said. "I don't want to lose my modesty. I want to please Allah."</p>
                
                <p>Later, as Amirah and Hasanah walked home, Hasanah smiled. "See? Being shy isn't bad. It's part of your faith."</p>
                
                <p>Amirah nodded proudly. "Yes, modesty makes us better Muslims."</p>
                
                <p>That evening, she told her parents what she had learned. Her father said, "Alḥamdulillāh, my dear. Modesty guards the soul like a shield." Her mother added, "And Allah loves those who are pure and humble."</p>
                
                <p>Before bed, Amirah whispered, "Alḥamdulillāh for the gift of modesty," knowing that her shyness was, in truth, her strength.</p> 
            </div>
            <div class="waiting-message">
                <p>Wait for the host to start the quiz...</p>
            </div>
            <button class="btn" onclick="markDoneReading()">Done Reading</button>
        </div>

        <!-- Quiz Screen -->
        <div class="screen hidden" id="quizScreen">
            <div class="timer" id="timer">30</div>
            <div class="question" id="question"></div>
            <div class="options" id="options"></div>
            <div class="score">Score: <span id="playerScore">0</span></div>
            <div class="waiting-message" id="waitingForNext" style="display: none;">
                <p>Waiting for host to continue...</p>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="screen hidden" id="resultsScreen">
            <h2>Quiz Complete!</h2>
            <div class="score">Your Final Score: <span id="finalScore">0</span></div>
            <div class="leaderboard" id="leaderboard"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="config.js"></script>
    <script>

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentRoom = null;
        let playerId = null;
        let playerName = '';
        let playerScore = 0;
        let currentQuestion = -1;
        let timeLeft = 30;
        let timerInterval = null;
        let selectedAnswer = null;
        let answerLocked = false;
        let hasAnswered = false;

        const questions = [
            {
                question: "Where were Amirah and Hasanah playing at the beginning of the story?",
                options: ["In the classroom", "In the playground", "At home", "In the library"],
                correct: 1
            },
            {
                question: "What did the older girls say about Amirah's modesty?",
                options: ["It was beautiful", "It was inspiring", "It was boring", "It was perfect"],
                correct: 2
            },
            {
                question: "How did Amirah feel after the older girls' comments?",
                options: ["Happy and confident", "Upset and doubtful", "Angry and defiant", "Proud and strong"],
                correct: 1
            },
            {
                question: "Who helped Amirah understand the value of modesty?",
                options: ["Her parents", "Hasanah", "Mrs. Rahma", "The older girls"],
                correct: 2
            },
            {
                question: "What did the Prophet ﷺ say about modesty?",
                options: ["'Modesty brings success'", "'Modesty is a part of faith'", "'Modesty is for women only'", "'Modesty should be avoided'"],
                correct: 1
            },
            {
                question: "According to Mrs. Rahma, what does being modest mean?",
                options: ["Being weak and quiet", "Respecting yourself and others", "Never speaking up", "Hiding from people"],
                correct: 1
            },
            {
                question: "What happens when a person loses modesty according to the story?",
                options: ["They become more successful", "They make more friends", "They start doing whatever they want", "They become happier"],
                correct: 2
            },
            {
                question: "What did Amirah say after understanding the lesson?",
                options: ["'I want to be like the older girls'", "'I don't want to lose my modesty'", "'Modesty is outdated'", "'I will change myself'"],
                correct: 1
            },
            {
                question: "What did Amirah's father say about modesty?",
                options: ["'It makes you weak'", "'It guards the soul like a shield'", "'It's not important'", "'It's only for children'"],
                correct: 1
            },
            {
                question: "How did Amirah feel about her modesty at the end of the story?",
                options: ["Ashamed and embarrassed", "Confused and uncertain", "Grateful and proud", "Worried and anxious"],
                correct: 2
            }
        ];

        // Get room code from URL
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');

        function hideAllScreens() {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
        }

        window.joinRoom = async () => {
            const playerNameInput = document.getElementById('playerName').value;
            const validatedName = validateInput(playerNameInput, 20);
            
            if (!validatedName) {
                alert('Please enter a valid name (1-20 characters)');
                return;
            }

            if (!roomFromUrl) {
                alert('Invalid room link');
                return;
            }

            playerName = validatedName;
            playerId = 'player_' + Date.now();
            currentRoom = roomFromUrl;

            try {
                const roomRef = database.ref(`rooms/${roomFromUrl}`);
                const snapshot = await roomRef.once('value');

                if (!snapshot.exists()) {
                    alert('Quiz room not found');
                    return;
                }

                await database.ref(`rooms/${roomFromUrl}/players/${playerId}`).set({
                    name: playerName,
                    score: 0
                });

                showWaitingScreen();
                listenToRoom();
            } catch (error) {
                alert('Error joining quiz. Please try again.');
            }
        };

        function showWaitingScreen() {
            hideAllScreens();
            document.getElementById('waitingScreen').classList.remove('hidden');
        }

        function listenToRoom() {
            const roomRef = database.ref(`rooms/${currentRoom}`);
            roomRef.on('value', (snapshot) => {
                if (!snapshot.exists()) {
                    alert('Quiz has ended');
                    return;
                }

                const roomData = snapshot.val();
                
                if (roomData.gameState === 'story') {
                    showStoryScreen();
                } else if (roomData.gameState === 'quiz') {
                    showQuizScreen(roomData);
                } else if (roomData.gameState === 'results') {
                    showResultsScreen(roomData.players || {});
                }
            });
        }

        function showStoryScreen() {
            hideAllScreens();
            document.getElementById('storyScreen').classList.remove('hidden');
        }

        window.markDoneReading = async () => {
            try {
                await database.ref(`rooms/${currentRoom}/players/${playerId}/doneReading`).set(true);
                document.querySelector('#storyScreen .btn').textContent = 'Reading Complete ✓';
                document.querySelector('#storyScreen .btn').disabled = true;
            } catch (error) {
                console.error('Error marking done reading:', error);
            }
        };

        function showQuizScreen(roomData) {
            hideAllScreens();
            document.getElementById('quizScreen').classList.remove('hidden');
            
            const newQuestion = roomData.currentQuestion || 0;
            if (newQuestion !== currentQuestion) {
                currentQuestion = newQuestion;
                loadQuestion(roomData.questionStartTime);
            }
        }

        function loadQuestion(startTime) {
            if (currentQuestion >= questions.length) return;
            
            const q = questions[currentQuestion];
            document.getElementById('question').textContent = q.question;
            document.getElementById('playerScore').textContent = playerScore;
            
            const optionsContainer = document.getElementById('options');
            optionsContainer.innerHTML = '';
            
            q.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';
                optionDiv.textContent = option;
                optionDiv.addEventListener('click', () => {
                    if (hasAnswered) return;
                    hasAnswered = true;
                    selectAnswer(index, optionDiv);
                });
                optionsContainer.appendChild(optionDiv);
            });
            
            selectedAnswer = null;
            answerLocked = false;
            hasAnswered = false;
            document.getElementById('waitingForNext').style.display = 'none';
            startTimer(startTime);
        }

        function startTimer(startTime) {
            clearInterval(timerInterval);
            
            // Always give players 30 seconds from when they load the question
            const playerStartTime = Date.now();
            
            const updateTimer = () => {
                const elapsed = Math.floor((Date.now() - playerStartTime) / 1000);
                timeLeft = Math.max(0, 30 - elapsed);
                document.getElementById('timer').textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timer').textContent = "Time's Up!";
                }
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        window.selectAnswer = async (index, element) => {
            console.log('selectAnswer called:', index);
            
            // Immediately disable all options
            const options = document.querySelectorAll('.option');
            options.forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.style.cursor = 'default';
            });
            
            console.log('Processing answer...');
            
            selectedAnswer = index;
            const q = questions[currentQuestion];
            
            // Always show the correct answer in green
            options[q.correct].classList.add('correct');
            
            // If wrong answer was selected, show it in red
            if (index !== q.correct) {
                element.classList.add('incorrect');
            } else {
                // If correct answer was selected, ensure it shows green
                element.classList.add('correct');
            }
            
            // Calculate score only once
            let points = 0;
            if (index === q.correct) {
                points = timeLeft > 0 ? timeLeft * 10 : 5;
                playerScore += points;
                console.log('Correct answer! Points added:', points, 'Total score:', playerScore);
            } else {
                console.log('Wrong answer, no points added');
            }
            
            document.getElementById('playerScore').textContent = playerScore;
            document.getElementById('currentScore').textContent = playerScore;
            
            // Update player score in database
            await database.ref(`rooms/${currentRoom}/players/${playerId}/score`).set(playerScore);
            
            clearInterval(timerInterval);
            
            // Show waiting message
            document.getElementById('waitingForNext').style.display = 'block';
        };

        function showResultsScreen(players) {
            const sortedPlayers = Object.entries(players).sort(([,a], [,b]) => (b.score || 0) - (a.score || 0));
            const playerRank = sortedPlayers.findIndex(([id]) => id === playerId) + 1;
            
            // Show animated ranking first
            showAnimatedRanking(playerRank, playerScore, sortedPlayers.length);
            
            // Prepare results screen data
            const prepareResults = () => {
                hideAllScreens();
                document.getElementById('resultsScreen').classList.remove('hidden');
                
                document.getElementById('finalScore').textContent = playerScore;
                
                const leaderboard = document.getElementById('leaderboard');
                leaderboard.innerHTML = '';
                
                sortedPlayers.forEach(([id, player], index) => {
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    if (id === playerId) {
                        item.style.background = '#e8f5e8';
                        item.style.fontWeight = 'bold';
                    }
                    const rankSpan = document.createElement('span');
                    rankSpan.className = 'rank';
                    rankSpan.textContent = `#${index + 1}`;
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.textContent = player.name;
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.appendChild(rankSpan);
                    leftDiv.appendChild(nameSpan);
                    
                    const scoreSpan = document.createElement('span');
                    scoreSpan.textContent = `${player.score || 0} points`;
                    
                    item.appendChild(leftDiv);
                    item.appendChild(scoreSpan);
                    leaderboard.appendChild(item);
                });
            };
            
            // Store function globally for ranking overlay to call
            window.showFinalResults = prepareResults;
        }
        
        function showAnimatedRanking(rank, score, totalPlayers) {
            const rankingOverlay = document.createElement('div');
            rankingOverlay.className = 'ranking-animation';
            
            const getRankSuffix = (rank) => {
                if (rank === 1) return 'st';
                if (rank === 2) return 'nd';
                if (rank === 3) return 'rd';
                return 'th';
            };
            
            const getRankColor = (rank) => {
                if (rank === 1) return 'linear-gradient(135deg, #FFD700, #FFA500)';
                if (rank === 2) return 'linear-gradient(135deg, #C0C0C0, #A9A9A9)';
                if (rank === 3) return 'linear-gradient(135deg, #CD7F32, #B8860B)';
                return 'linear-gradient(135deg, #667eea, #764ba2)';
            };
            
            rankingOverlay.innerHTML = `
                <div class="ranking-tile" style="background: ${getRankColor(rank)}">
                    <div class="ranking-number">${rank}<sup>${getRankSuffix(rank)}</sup></div>
                    <div class="ranking-text">Place</div>
                    <div class="ranking-score">${score} points</div>
                    <div class="ranking-score">out of ${totalPlayers} players</div>
                </div>
            `;
            
            document.body.appendChild(rankingOverlay);
            
            // Add click to dismiss and show results
            rankingOverlay.onclick = () => {
                rankingOverlay.remove();
                if (window.showFinalResults) {
                    window.showFinalResults();
                }
            };
            
            // Add tap instruction
            const tapInstruction = document.createElement('div');
            tapInstruction.style.cssText = 'position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.8); font-size: 0.9rem;';
            tapInstruction.textContent = 'Tap to continue';
            rankingOverlay.querySelector('.ranking-tile').appendChild(tapInstruction);
        }

        // Auto-join if room code is in URL
        if (roomFromUrl) {
            document.getElementById('joinScreen').querySelector('h2').textContent = `Join Quiz Room: ${roomFromUrl}`;
        } else {
            document.getElementById('joinScreen').innerHTML = '<h2>Invalid Quiz Link</h2><p>Please use the correct link provided by your host.</p>';
        }
    </script>
</body>
</html>
